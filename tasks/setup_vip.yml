---

- ansible.builtin.set_fact:
    kubernetes_init: "{% if kubernetes_init_host is defined and  kubernetes_init_host == inventory_hostname %}yes{% else %}no{% endif %}"

- ansible.builtin.set_fact:
    kubernetes_iface: "{{ hostvars[inventory_hostname]['ansible_' + item ]['device'] }}"
  when: 
    - ansible_interfaces | length > 2
    - kubernetes_vip_ip is defined
    - hostvars[inventory_hostname]['ansible_' + item ].ipv4 is defined 
    - hostvars[inventory_hostname]['ansible_' + item ]['ipv4']['address'] | ansible.utils.ipaddr( kubernetes_subnet )
  with_items: "{{ ansible_interfaces }}"

- ansible.builtin.set_fact:
    kubernetes_iface: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['interface'] }}"
  when: 
    - ansible_interfaces | length <= 2

- name: Create /etc/kubernetes/manifests/ directory
  ansible.builtin.file: 
    name: /etc/kubernetes/manifests/
    state: directory

- name: render kube-vip.yml
  ansible.builtin.template:
    src: kube-vip-init.yml.j2
    dest: /etc/kubernetes/manifests/kube-vip.yaml
  when:
    - kubernetes_init
  notify:
    - wait kube-vip

- name: render kube-vip.yml
  ansible.builtin.template:
    src: kube-vip.yml.j2
    dest: /etc/kubernetes/manifests/kube-vip.yaml
  when:
    - not kubernetes_init
  notify:
    - wait kube-vip